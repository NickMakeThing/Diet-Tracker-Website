<!DOCTYPE html>
<html>
<head>
<title>Major Group Project</title>
<script src="https://cdn.plot.ly/plotly-2.3.1.min.js"></script>
<link rel="shortcut icon" href="#">
</head>
<style>
  /* body {border-color:red} */
h1 {
  padding-left:12px;
}
.super-container {
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
}
.left-container {
  height: 600px;
  min-width: 425px;
  max-width: 425px;
  padding-left:12px;
  padding-right:25px;
}
.right-container {
}
.graph {
  height: 600px;
  width: 750px;
  border-style: solid;
  float: left;
  overflow: visible;
  z-index:1;
}
.controls-container {
  height: 200px;
  width: 750px;
  clear:left;
  display:flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  /* border:red solid 1px; */
  /* float:left; */
}
.buttons {
  height: 600px;
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;
}
.nutrients {
  display: flex;
  flex-direction: row;
  width: 750px;
  justify-content: space-evenly;
}
.modebar{
  display: none !important;
}

.chart-type{
  float: left;
  display: flex;
  flex-direction: row;
  justify-content: space-evenly;
  width: 750px
}

#inactivity{
  width:125px;
  height:25px;
}
/* .nutrients input {
  -webkit-appearance: none;
  -moz-appearance: none;
  -o-appearance: none;
} */
#slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  display: block;
  width: 100px; 
  height: 5px; 
  background: darkgrey; 
  outline: none; 
  opacity: 0.8; 
  -webkit-transition: .1s; 
  transition: opacity .1s;
}
@media screen and (max-width: 1300px) {
  .super-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
}
@media screen and (max-width: 875px) {
  .right-container{
    transform: scale(0.75);
    margin-left: -70px;
  }
}
</style>
<body>
<h1>Nutrition/Consumption Tracker</h1>
<div class="super-container">
  <div class="left-container">

    <p>
      <h4>About</h4>
      The purpose of this project is to create an onsite device which tracks the consumption of a user over time. 
      The consumption tracker will detect changes in weight of a food product, and upload the data to a webserver so it may be displayed on a graph to the user.
    </p>
    <p>
      <h4>Controls</h4>
      The options on the right of the graph allow the user to organize the displayed data by time. Selecting each option will cause consumption amounts to be aggregated into different time periods. 
      For example, the yearly option shows how much is consumed per month.<br/>
      <ul>
        <li>yearly : per month</li>
        <li>monthly : per week</li>
        <li>weekly : per day</li>
        <li>daily : per hour</li>
      </ul>
      <!-- 
        yearly shows consumption for each month
        monthly shows consumption for each week
        weekly shows consumption for each day
        daily shows consumption for each hour 
      -->
    </p>
    <p>The 'Show Inactivity' button shows what times when information was not recorded. For example, if data was not recorded for an entire month,
      and the yearly option is set, then the graph will display this month, but with a value of 0 for that month.
    </p>
    <p>
      The check boxes at the top of the graph allow the user to control whether information of individual macro nutrients is shown.  
    </p>
  </div>
  <div class="right-container">
    <span class="nutrients">
      <span>energy<input type="checkbox" id="energy" checked="true" onclick="create_graph()" ></span>
      <span>protein<input type="checkbox" id="protein" onclick="create_graph()" style=" background-color: red;"></span>
      <span>fat<input type="checkbox" id="fat" onclick="create_graph()"></span>
      <span>carbs<input type="checkbox" id="carbs" onclick="create_graph()"></span>
      <!--
      <span>energy<input type="radio" name="macro" value=energy id="energy" checked="true" onclick="create_graph()" ></span>
      <span>protein<input type="radio" name="macro" value=protein id="protein" onclick="create_graph()" style=" background-color: red;"></span>
      <span>fat<input type="radio" name="macro" value=fat id="fat" onclick="create_graph()"></span>
      <span>carbs<input type="radio" name="macro" value=carbs id="carbs" onclick="create_graph()"></span> -->
    </span>
    <div class="graph" id='chart'></div>
    <div class="buttons">
      <span><input type="radio" name="time" value="yearly" id="yearly"  onclick="create_graph()">yearly</span>
      <span><input type="radio" name="time" value="monthly" id="monthly" checked onclick="pag_click(this.parentElement.innerText)">monthly</span>
      <span><input type="radio" name="time" value="weekly" id="weekly" onclick="pag_click(this.parentElement.innerText)">weekly</span>
      <span><input type="radio" name="time" value="daily" id="daily" onclick="pag_click(this.parentElement.innerText)">daily</span>
    </div>
    <div class='chart-type'>
      <span>Lines<input type="radio" name="format" id="lines" checked='true' onclick="create_graph()"></span> 
      <span>Bars<input type="radio" name="format" id="bars" onclick="create_graph()"></span>
    </div>
    <div class='controls-container'>
      <button id='inactivity' onclick="show_inactivity(this)">Show Inactivity</button>
      <div id='pagination'>
        <button id='pag-left' onclick="turn_page_back(innerText)">&lt;-</button>
        <span id='pag-period'></span><span id='pag-text'></span>
        <button id='pag-right' onclick="turn_page_forward(innerText)">-&gt;</button>
      </div>
      <input type="range" min="1" max="100" value="50" id="slider" onmouseup="slider_mouseup(this.value)" onmousedown="slider_mousedown()" onmousemove="slider_move(this.value)">
    </div>
  </div>
</div>
</body>
<script>
  /*
  TODO:
    halve amount of test data
  */
  test_data='{"3df1d4b96d8976ff5986393e8767f5b2": {"name": null, "energy": 900.0, "protein": 21.0, "fat": 3.0, "carbs": 15.0, "events": [["2021-06-14 13:35:00", 87.0], ["2021-06-14 21:37:00", 90.0], ["2021-06-15 08:09:00", 67.0], ["2021-06-15 14:05:00", 78.0], ["2021-06-15 17:44:00", 122.0], ["2021-06-16 10:35:00", 88.0], ["2021-06-16 15:15:00", 111.0], ["2021-06-16 21:41:00", 74.0], ["2021-06-17 08:03:00", 76.0], ["2021-06-17 17:41:00", 137.0], ["2021-06-18 08:18:00", 61.0], ["2021-06-18 14:42:00", 122.0], ["2021-06-18 19:39:00", 81.0], ["2021-06-19 09:38:00", 106.0], ["2021-06-19 14:18:00", 121.0], ["2021-06-19 21:10:00", 66.0], ["2021-06-20 10:31:00", 120.0], ["2021-06-20 17:35:00", 129.0], ["2021-06-21 10:28:00", 138.0], ["2021-06-21 15:27:00", 133.0], ["2021-06-21 18:07:00", 140.0], ["2021-06-22 10:25:00", 69.0], ["2021-06-22 15:29:00", 68.0], ["2021-06-22 21:27:00", 79.0], ["2021-06-23 08:30:00", 131.0], ["2021-06-23 17:27:00", 149.0], ["2021-06-24 09:30:00", 67.0], ["2021-06-24 14:35:00", 107.0], ["2021-06-24 17:39:00", 106.0], ["2021-06-25 09:29:00", 54.0], ["2021-06-25 14:42:00", 89.0], ["2021-06-25 19:03:00", 131.0], ["2021-06-26 10:37:00", 101.0], ["2021-06-26 21:19:00", 119.0], ["2021-06-27 09:35:00", 54.0], ["2021-06-27 13:37:00", 116.0], ["2021-06-27 17:05:00", 68.0], ["2021-06-28 08:21:00", 89.0], ["2021-06-28 13:20:00", 59.0], ["2021-06-28 20:07:00", 112.0], ["2021-06-29 09:24:00", 121.0], ["2021-06-29 13:29:00", 118.0], ["2021-06-30 10:09:00", 103.0], ["2021-06-30 13:15:00", 71.0], ["2021-06-30 18:12:00", 57.0], ["2021-07-01 09:39:00", 118.0], ["2021-07-01 14:36:00", 80.0], ["2021-07-01 18:13:00", 97.0], ["2021-07-02 09:20:00", 92.0], ["2021-07-02 13:12:00", 94.0], ["2021-07-02 18:00:00", 103.0], ["2021-07-03 15:36:00", 50.0], ["2021-07-03 17:39:00", 77.0], ["2021-07-04 09:34:00", 82.0], ["2021-07-04 15:33:00", 132.0], ["2021-07-04 20:31:00", 72.0], ["2021-07-05 08:24:00", 102.0], ["2021-07-05 14:25:00", 61.0], ["2021-07-05 19:33:00", 54.0], ["2021-07-06 09:09:00", 67.0], ["2021-07-06 14:31:00", 72.0], ["2021-07-07 10:12:00", 137.0], ["2021-07-07 14:35:00", 106.0], ["2021-07-07 18:09:00", 74.0], ["2021-07-08 08:05:00", 150.0], ["2021-07-08 14:39:00", 136.0], ["2021-07-08 18:34:00", 150.0], ["2021-07-09 08:10:00", 83.0], ["2021-07-09 17:06:00", 70.0], ["2021-07-10 08:32:00", 126.0], ["2021-07-10 13:20:00", 90.0], ["2021-07-10 17:00:00", 119.0], ["2021-07-11 08:17:00", 88.0], ["2021-07-11 14:11:00", 78.0], ["2021-07-11 20:17:00", 126.0], ["2021-07-12 10:00:00", 95.0], ["2021-07-12 20:04:00", 114.0], ["2021-07-13 08:20:00", 105.0], ["2021-07-13 14:42:00", 117.0], ["2021-07-13 17:03:00", 64.0], ["2021-07-14 08:11:00", 89.0], ["2021-07-14 15:35:00", 94.0], ["2021-07-14 20:15:00", 115.0], ["2021-07-15 09:04:00", 144.0], ["2021-07-15 20:29:00", 52.0], ["2021-07-16 09:39:00", 72.0], ["2021-07-16 13:15:00", 64.0], ["2021-07-16 19:38:00", 56.0], ["2021-07-17 08:05:00", 92.0], ["2021-07-17 15:14:00", 94.0], ["2021-07-17 18:08:00", 135.0], ["2021-07-18 09:04:00", 64.0], ["2021-07-18 15:40:00", 95.0], ["2021-07-19 10:01:00", 114.0], ["2021-07-19 14:12:00", 66.0], ["2021-07-19 19:13:00", 67.0], ["2021-07-20 08:40:00", 109.0], ["2021-07-20 15:37:00", 128.0], ["2021-07-20 18:37:00", 75.0], ["2021-07-21 09:12:00", 127.0], ["2021-07-21 15:45:00", 104.0], ["2021-07-22 10:26:00", 132.0], ["2021-07-22 13:25:00", 133.0], ["2021-07-22 20:13:00", 114.0], ["2021-07-23 09:36:00", 114.0], ["2021-07-23 13:11:00", 120.0], ["2021-07-23 21:04:00", 115.0], ["2021-07-24 08:37:00", 124.0], ["2021-07-24 17:09:00", 112.0], ["2021-07-25 10:36:00", 139.0], ["2021-07-25 14:41:00", 100.0], ["2021-07-25 19:34:00", 119.0], ["2021-07-26 09:41:00", 77.0], ["2021-07-26 13:28:00", 80.0], ["2021-07-26 19:42:00", 113.0], ["2021-07-27 10:37:00", 88.0], ["2021-07-27 21:42:00", 112.0], ["2021-07-28 08:15:00", 81.0], ["2021-07-28 14:35:00", 142.0], ["2021-07-28 18:21:00", 65.0], ["2021-07-29 09:41:00", 133.0], ["2021-07-29 15:37:00", 142.0], ["2021-07-29 20:31:00", 76.0], ["2021-07-30 09:30:00", 89.0], ["2021-07-30 21:34:00", 120.0], ["2021-07-31 09:15:00", 67.0], ["2021-07-31 13:03:00", 99.0], ["2021-07-31 20:32:00", 123.0], ["2021-08-01 08:25:00", 68.0], ["2021-08-01 13:19:00", 114.0], ["2021-08-01 17:17:00", 52.0], ["2021-08-02 09:07:00", 88.0], ["2021-08-02 13:22:00", 136.0], ["2021-08-03 10:16:00", 116.0], ["2021-08-03 13:34:00", 132.0], ["2021-08-03 19:01:00", 93.0], ["2021-08-04 10:24:00", 60.0], ["2021-08-04 14:03:00", 60.0], ["2021-08-04 21:32:00", 96.0], ["2021-08-05 09:19:00", 103.0], ["2021-08-05 14:41:00", 102.0], ["2021-08-06 09:00:00", 79.0], ["2021-08-06 15:02:00", 128.0], ["2021-08-06 21:11:00", 78.0], ["2021-08-07 08:26:00", 76.0], ["2021-08-07 14:00:00", 112.0], ["2021-08-07 20:38:00", 63.0], ["2021-08-08 08:13:00", 81.0], ["2021-08-08 15:28:00", 150.0], ["2021-08-08 19:38:00", 67.0], ["2021-08-09 15:28:00", 51.0], ["2021-08-09 19:17:00", 61.0], ["2021-08-10 08:34:00", 134.0], ["2021-08-10 14:26:00", 149.0], ["2021-08-10 17:26:00", 60.0], ["2021-08-11 08:39:00", 85.0], ["2021-08-11 13:17:00", 50.0], ["2021-08-11 19:15:00", 102.0], ["2021-08-12 09:01:00", 147.0], ["2021-08-12 20:21:00", 73.0], ["2021-08-13 08:06:00", 138.0], ["2021-08-13 13:12:00", 104.0], ["2021-08-13 20:03:00", 52.0], ["2021-08-14 09:19:00", 71.0], ["2021-08-14 13:10:00", 133.0], ["2021-08-14 18:30:00", 82.0], ["2021-08-15 08:32:00", 105.0], ["2021-08-15 20:33:00", 77.0], ["2021-08-16 08:10:00", 146.0], ["2021-08-16 15:02:00", 84.0], ["2021-08-16 20:30:00", 108.0], ["2021-08-17 08:32:00", 77.0], ["2021-08-17 14:36:00", 95.0], ["2021-08-17 17:30:00", 89.0], ["2021-08-18 08:36:00", 96.0], ["2021-08-18 20:07:00", 147.0], ["2021-08-19 08:31:00", 141.0], ["2021-08-19 14:21:00", 136.0], ["2021-08-19 20:40:00", 67.0], ["2021-08-20 08:16:00", 118.0], ["2021-08-20 15:16:00", 135.0], ["2021-08-20 20:43:00", 75.0], ["2021-08-21 15:18:00", 138.0], ["2021-08-21 20:22:00", 60.0], ["2021-08-22 09:42:00", 137.0], ["2021-08-22 14:01:00", 69.0], ["2021-08-22 19:02:00", 115.0], ["2021-08-23 08:18:00", 99.0], ["2021-08-23 14:27:00", 73.0], ["2021-08-23 20:14:00", 100.0], ["2021-08-24 14:23:00", 99.0], ["2021-08-24 17:23:00", 56.0], ["2021-08-25 08:04:00", 144.0], ["2021-08-25 15:29:00", 121.0], ["2021-08-25 18:30:00", 55.0], ["2021-08-26 09:07:00", 103.0], ["2021-08-26 13:22:00", 103.0], ["2021-08-26 17:44:00", 65.0], ["2021-08-27 08:24:00", 65.0], ["2021-08-27 21:23:00", 95.0], ["2021-08-28 10:30:00", 147.0], ["2021-08-28 14:25:00", 59.0], ["2021-08-28 19:17:00", 128.0], ["2021-08-29 08:06:00", 82.0], ["2021-08-29 14:07:00", 57.0], ["2021-08-29 20:13:00", 143.0], ["2021-08-30 09:39:00", 72.0], ["2021-08-30 18:00:00", 66.0], ["2021-08-31 09:05:00", 117.0], ["2021-08-31 14:08:00", 102.0], ["2021-08-31 20:13:00", 60.0], ["2021-09-01 09:24:00", 98.0], ["2021-09-01 13:18:00", 68.0], ["2021-09-01 18:06:00", 72.0], ["2021-09-02 09:38:00", 138.0], ["2021-09-02 15:29:00", 104.0], ["2021-09-03 08:33:00", 76.0], ["2021-09-03 14:14:00", 145.0], ["2021-09-03 20:26:00", 112.0], ["2021-09-04 08:23:00", 110.0], ["2021-09-04 13:45:00", 147.0], ["2021-09-04 20:26:00", 116.0], ["2021-09-05 09:11:00", 124.0], ["2021-09-05 19:37:00", 121.0], ["2021-09-06 09:07:00", 103.0], ["2021-09-06 15:23:00", 148.0], ["2021-09-06 20:37:00", 95.0], ["2021-09-07 09:04:00", 65.0], ["2021-09-07 14:22:00", 73.0], ["2021-09-07 20:25:00", 86.0], ["2021-09-08 08:36:00", 85.0], ["2021-09-08 13:31:00", 71.0], ["2021-09-09 10:16:00", 130.0], ["2021-09-09 14:07:00", 54.0], ["2021-09-09 21:13:00", 85.0], ["2021-09-10 08:01:00", 65.0], ["2021-09-10 13:41:00", 127.0], ["2021-09-10 21:28:00", 69.0], ["2021-09-11 10:36:00", 96.0], ["2021-09-11 15:27:00", 85.0], ["2021-09-11 21:31:00", 93.0], ["2021-09-12 14:42:00", 150.0], ["2021-09-12 17:36:00", 127.0], ["2021-09-13 09:41:00", 139.0], ["2021-09-13 14:32:00", 126.0], ["2021-09-13 19:38:00", 90.0], ["2021-09-14 09:14:00", 145.0], ["2021-09-14 18:15:00", 78.0]]}}'//, "c5cc17e395d3049b03e0f1ccebb02b4d": {"name": null, "energy": 1400.0, "protein": 15.0, "fat": 5.0, "carbs": 30.0, "events": [["2021-06-14 15:31:00", 134.0], ["2021-06-14 20:00:00", 139.0], ["2021-06-15 08:04:00", 107.0], ["2021-06-15 15:26:00", 90.0], ["2021-06-15 18:25:00", 63.0], ["2021-06-16 10:25:00", 116.0], ["2021-06-16 15:10:00", 62.0], ["2021-06-16 18:17:00", 72.0], ["2021-06-17 13:19:00", 62.0], ["2021-06-17 18:06:00", 96.0], ["2021-06-18 08:07:00", 64.0], ["2021-06-18 14:26:00", 136.0], ["2021-06-18 17:35:00", 54.0], ["2021-06-19 10:27:00", 116.0], ["2021-06-19 15:12:00", 92.0], ["2021-06-19 18:18:00", 127.0], ["2021-06-20 14:23:00", 126.0], ["2021-06-20 19:21:00", 93.0], ["2021-06-21 08:33:00", 110.0], ["2021-06-21 15:45:00", 120.0], ["2021-06-21 17:01:00", 85.0], ["2021-06-22 08:27:00", 126.0], ["2021-06-22 14:29:00", 87.0], ["2021-06-23 08:20:00", 139.0], ["2021-06-23 13:05:00", 111.0], ["2021-06-23 21:05:00", 110.0], ["2021-06-24 08:07:00", 132.0], ["2021-06-24 14:24:00", 142.0], ["2021-06-24 18:29:00", 113.0], ["2021-06-25 10:28:00", 69.0], ["2021-06-25 19:27:00", 62.0], ["2021-06-26 08:05:00", 59.0], ["2021-06-26 15:04:00", 108.0], ["2021-06-26 21:27:00", 117.0], ["2021-06-27 08:40:00", 78.0], ["2021-06-27 15:05:00", 62.0], ["2021-06-27 18:03:00", 75.0], ["2021-06-28 08:26:00", 55.0], ["2021-06-28 13:24:00", 135.0], ["2021-06-28 19:24:00", 129.0], ["2021-06-29 13:04:00", 121.0], ["2021-06-29 21:24:00", 96.0], ["2021-06-30 09:22:00", 86.0], ["2021-06-30 15:08:00", 85.0], ["2021-06-30 19:44:00", 93.0], ["2021-07-01 08:26:00", 115.0], ["2021-07-01 14:39:00", 71.0], ["2021-07-01 17:30:00", 69.0], ["2021-07-02 10:34:00", 142.0], ["2021-07-02 18:36:00", 104.0], ["2021-07-03 08:24:00", 82.0], ["2021-07-03 15:39:00", 66.0], ["2021-07-03 19:06:00", 50.0], ["2021-07-04 09:30:00", 69.0], ["2021-07-04 15:31:00", 56.0], ["2021-07-04 19:13:00", 119.0], ["2021-07-05 08:33:00", 150.0], ["2021-07-05 14:24:00", 131.0], ["2021-07-06 09:20:00", 68.0], ["2021-07-06 13:17:00", 100.0], ["2021-07-06 18:14:00", 63.0], ["2021-07-07 10:19:00", 129.0], ["2021-07-07 15:22:00", 128.0], ["2021-07-07 20:13:00", 119.0], ["2021-07-08 08:09:00", 114.0], ["2021-07-08 20:09:00", 133.0], ["2021-07-09 08:09:00", 87.0], ["2021-07-09 13:09:00", 114.0], ["2021-07-09 20:12:00", 122.0], ["2021-07-10 08:37:00", 99.0], ["2021-07-10 15:44:00", 136.0], ["2021-07-10 19:30:00", 74.0], ["2021-07-11 10:21:00", 125.0], ["2021-07-11 18:34:00", 94.0], ["2021-07-12 08:26:00", 122.0], ["2021-07-12 14:27:00", 111.0], ["2021-07-12 17:06:00", 109.0], ["2021-07-13 09:06:00", 77.0], ["2021-07-13 13:26:00", 78.0], ["2021-07-13 20:06:00", 73.0], ["2021-07-14 08:01:00", 105.0], ["2021-07-14 15:15:00", 135.0], ["2021-07-15 10:05:00", 52.0], ["2021-07-15 15:10:00", 117.0], ["2021-07-15 21:44:00", 107.0], ["2021-07-16 08:32:00", 123.0], ["2021-07-16 15:02:00", 102.0], ["2021-07-16 21:06:00", 106.0], ["2021-07-17 09:02:00", 110.0], ["2021-07-17 14:14:00", 68.0], ["2021-07-18 08:32:00", 144.0], ["2021-07-18 13:13:00", 103.0], ["2021-07-18 18:15:00", 145.0], ["2021-07-19 08:02:00", 129.0], ["2021-07-19 15:35:00", 114.0], ["2021-07-19 17:11:00", 73.0], ["2021-07-20 09:44:00", 120.0], ["2021-07-20 20:11:00", 126.0], ["2021-07-21 09:29:00", 75.0], ["2021-07-21 15:16:00", 117.0], ["2021-07-21 19:27:00", 123.0], ["2021-07-22 09:11:00", 99.0], ["2021-07-22 14:08:00", 141.0], ["2021-07-22 19:43:00", 83.0], ["2021-07-23 15:13:00", 74.0], ["2021-07-23 19:21:00", 68.0], ["2021-07-24 08:43:00", 77.0], ["2021-07-24 14:03:00", 92.0], ["2021-07-24 20:19:00", 128.0], ["2021-07-25 08:16:00", 121.0], ["2021-07-25 13:33:00", 60.0], ["2021-07-25 19:22:00", 105.0], ["2021-07-26 10:00:00", 144.0], ["2021-07-26 18:22:00", 117.0], ["2021-07-27 10:02:00", 117.0], ["2021-07-27 14:11:00", 108.0], ["2021-07-27 18:27:00", 148.0], ["2021-07-28 08:37:00", 55.0], ["2021-07-28 13:19:00", 101.0], ["2021-07-28 19:17:00", 131.0], ["2021-07-29 13:18:00", 104.0], ["2021-07-29 17:03:00", 56.0], ["2021-07-30 08:32:00", 134.0], ["2021-07-30 14:35:00", 135.0], ["2021-07-30 21:39:00", 116.0], ["2021-07-31 08:37:00", 133.0], ["2021-07-31 15:13:00", 58.0], ["2021-07-31 20:01:00", 68.0], ["2021-08-01 15:45:00", 60.0], ["2021-08-01 21:03:00", 94.0], ["2021-08-02 10:11:00", 100.0], ["2021-08-02 15:28:00", 139.0], ["2021-08-02 18:40:00", 57.0], ["2021-08-03 10:06:00", 83.0], ["2021-08-03 14:09:00", 121.0], ["2021-08-03 20:03:00", 122.0], ["2021-08-04 13:18:00", 124.0], ["2021-08-04 20:12:00", 141.0], ["2021-08-05 10:05:00", 55.0], ["2021-08-05 13:43:00", 148.0], ["2021-08-05 20:08:00", 91.0], ["2021-08-06 10:20:00", 66.0], ["2021-08-06 13:22:00", 71.0], ["2021-08-06 21:07:00", 80.0], ["2021-08-07 13:09:00", 117.0], ["2021-08-07 18:09:00", 146.0], ["2021-08-08 09:22:00", 86.0], ["2021-08-08 15:39:00", 111.0], ["2021-08-08 19:03:00", 98.0], ["2021-08-09 08:32:00", 67.0], ["2021-08-09 15:01:00", 97.0], ["2021-08-10 08:19:00", 129.0], ["2021-08-10 14:09:00", 89.0], ["2021-08-10 19:02:00", 67.0], ["2021-08-11 09:14:00", 101.0], ["2021-08-11 14:43:00", 113.0], ["2021-08-11 21:35:00", 90.0], ["2021-08-12 10:45:00", 92.0], ["2021-08-12 14:00:00", 97.0], ["2021-08-13 08:13:00", 133.0], ["2021-08-13 15:39:00", 51.0], ["2021-08-13 18:13:00", 76.0], ["2021-08-14 09:32:00", 88.0], ["2021-08-14 15:24:00", 92.0], ["2021-08-14 17:12:00", 107.0], ["2021-08-15 08:11:00", 92.0], ["2021-08-15 13:03:00", 94.0], ["2021-08-16 08:22:00", 88.0], ["2021-08-16 14:43:00", 79.0], ["2021-08-16 17:00:00", 110.0], ["2021-08-17 09:27:00", 63.0], ["2021-08-17 15:12:00", 149.0], ["2021-08-17 18:20:00", 94.0], ["2021-08-18 10:06:00", 107.0], ["2021-08-18 14:02:00", 120.0], ["2021-08-19 08:01:00", 61.0], ["2021-08-19 13:27:00", 76.0], ["2021-08-19 20:02:00", 82.0], ["2021-08-20 09:17:00", 72.0], ["2021-08-20 13:16:00", 125.0], ["2021-08-20 21:10:00", 113.0], ["2021-08-21 09:11:00", 93.0], ["2021-08-21 15:42:00", 117.0], ["2021-08-21 21:44:00", 77.0], ["2021-08-22 13:11:00", 62.0], ["2021-08-22 19:41:00", 92.0], ["2021-08-23 09:16:00", 100.0], ["2021-08-23 14:23:00", 99.0], ["2021-08-23 20:31:00", 127.0], ["2021-08-24 08:27:00", 141.0], ["2021-08-24 14:27:00", 112.0], ["2021-08-25 09:22:00", 63.0], ["2021-08-25 14:13:00", 105.0], ["2021-08-25 20:42:00", 134.0], ["2021-08-26 10:24:00", 149.0], ["2021-08-26 15:27:00", 145.0], ["2021-08-26 20:13:00", 119.0], ["2021-08-27 09:29:00", 135.0], ["2021-08-27 18:38:00", 57.0], ["2021-08-28 09:42:00", 112.0], ["2021-08-28 14:18:00", 136.0], ["2021-08-28 17:38:00", 51.0], ["2021-08-29 08:13:00", 130.0], ["2021-08-29 14:19:00", 75.0], ["2021-08-29 18:43:00", 69.0], ["2021-08-30 09:07:00", 109.0], ["2021-08-30 15:21:00", 140.0], ["2021-08-31 10:19:00", 112.0], ["2021-08-31 13:21:00", 115.0], ["2021-08-31 19:16:00", 100.0], ["2021-09-01 08:22:00", 117.0], ["2021-09-01 15:12:00", 65.0], ["2021-09-01 20:04:00", 129.0], ["2021-09-02 10:35:00", 112.0], ["2021-09-02 20:35:00", 91.0], ["2021-09-03 10:28:00", 50.0], ["2021-09-03 13:26:00", 93.0], ["2021-09-03 19:28:00", 148.0], ["2021-09-04 08:05:00", 89.0], ["2021-09-04 15:07:00", 81.0], ["2021-09-04 21:04:00", 100.0], ["2021-09-05 08:27:00", 58.0], ["2021-09-05 14:09:00", 105.0], ["2021-09-06 10:27:00", 144.0], ["2021-09-06 15:29:00", 92.0], ["2021-09-06 21:06:00", 94.0], ["2021-09-07 08:20:00", 70.0], ["2021-09-07 15:06:00", 108.0], ["2021-09-07 20:33:00", 56.0], ["2021-09-08 08:11:00", 64.0], ["2021-09-08 15:40:00", 143.0], ["2021-09-09 09:12:00", 97.0], ["2021-09-09 14:06:00", 149.0], ["2021-09-09 21:16:00", 80.0], ["2021-09-10 08:14:00", 99.0], ["2021-09-10 13:38:00", 63.0], ["2021-09-10 17:33:00", 53.0], ["2021-09-11 08:27:00", 96.0], ["2021-09-11 13:08:00", 121.0], ["2021-09-12 09:08:00", 102.0], ["2021-09-12 14:34:00", 65.0], ["2021-09-12 18:14:00", 113.0], ["2021-09-13 08:30:00", 85.0], ["2021-09-13 15:19:00", 120.0], ["2021-09-13 21:01:00", 93.0], ["2021-09-14 09:39:00", 58.0], ["2021-09-14 14:32:00", 150.0], ["2021-09-14 18:01:00", 97.0]]}
  consumption_data='{{ stats|safe }}'
  a=JSON.parse(consumption_data)
  //a['3df1d4b96d8976ff5986393e8767f5b2'].events.splice(127)
  //console.log(a['3df1d4b96d8976ff5986393e8767f5b2'].events.slice(-1))
  chart = document.getElementById('chart')
  console.log(a)
  lines_setting = document.getElementById('lines')
  bars_setting = document.getElementById('bars')
  buttons = document.getElementsByClassName('buttons')[0].getElementsByTagName('input')

  function pag_click(date_format){
    pag_text = document.getElementById('pag-text')
    pag_period = document.getElementById('pag-period')
    pag_text.innerText = ''
    if(date_format == 'daily'){
      if(inactivity.innerText == 'Show Inactivity') inactivity.click()
        pag_period.innerText = 'Showing Day: '
      } else if (date_format == 'weekly'){
        pag_period.innerText = 'Showing Week: '
      } else if (date_format == 'monthly') {
        pag_period.innerText = 'Showing Month: '
      }
    create_graph()
  }

  function slider_mouseup(value){
    pag_text = document.getElementById('pag-text')
    text = pag_text.innerText.split('/')
    pag_text.innerText = value + '/' + text[1]
    this.checked = false
    create_graph()
  }

  function slider_mousedown(){
    this.checked = true
  }

  function slider_move(value){
    if(this.checked){
    pag_text = document.getElementById('pag-text')
    slider = document.getElementById('slider')
    text = pag_text.innerText.split('/')
    pag_text.innerText = value + '/' + text[1]
    }
  }

  function turn_page_forward(innerText){
    page_text = document.getElementById('pag-text')
    slider = document.getElementById('slider')
    if(!yearly.checked){
      text = page_text.innerText.split('/')
      if(parseInt(text[0])+1 <= text[1]){
        text[0] = parseInt(text[0])+1
        page_text.innerText = text[0]+'/'+text[1] 
        slider.value = text[0]
      }
    }
    create_graph()
  }

  function turn_page_back(innerText){
    page_text = document.getElementById('pag-text')
    if(!yearly.checked){
      text = page_text.innerText.split('/')
      if(text[0]-1){ 
        text[0] = text[0]-1
        page_text.innerText = text[0]+'/'+text[1] 
        slider.value = text[0]
      }
    }
    create_graph()
  }

  function paginate(events,date_format){
      page_text = document.getElementById('pag-text')
      slider = document.getElementById('slider')
      pages = []   
      if(date_format=='daily'){
        last_period = {energy:{x:'0am 00/00'}} 
        get_period = (x) => x.split(' ')[1]
      } else if (date_format=='weekly'){
        last_period = {energy:{x:'00/00/00'}} 
        get_period = (x) => {
          date = x.split('/')
          date = date[1]+'/'+date[0]+'/'+date[2]
          return week_number(new Date(date))
        }
      } else if(date_format=='monthly') { 
        last_period = {energy:{x:'00/00/00'}}
        get_period = (x) => {
          date = x.split('/')
          date = new Date(date[1]+'/'+date[0]+'/'+date[2])
          return date.getMonth()
        }
      } else {
        return []}
        // if(!page_number.innerText) page_number.innerText = 1
        page=[]
        for (i of events){
          x = i.energy.x
          index = events.indexOf(i)
          period = get_period(x)
          last_period = get_period(last_period.energy.x)
          if(index == 0){ 
            page.push(i) 
          } else {
            if(period == last_period){
              page.push(i)
            } else {
              pages.push(page)
              page = [i]
            }
          }
          last_period = i
        }
        pages_len = pages.length
        if(pages_len) pages.push(page)
        if (!page_text.innerText){//need to adjust if weekly comes into picture
          page_text.innerText = '1/'+(pages_len+1)
          slider.value = 1
          slider.max = pages_len+1
        }
    return pages
  }

  function show_inactivity(inactivity_button){
    if (inactivity_button.innerText == 'Show Inactivity'){
      inactivity_button.innerText = 'Hide Inactivity'
    } else if (inactivity_button.innerText == 'Hide Inactivity'){
      inactivity_button.innerText  = 'Show Inactivity'
    }
    create_graph()
  }
  function collect(data){
    var events = []
    var dates = []
    for (product in data){
      for (event of data[product].events){
        date = new Date(event[0].replace(" ","T"))
        dates.push(date)
        events.push({
          energy : {y:(event[1]/100)*data[product].energy, x: date}, 
          protein : {y:(event[1]/100)*data[product].protein, x: date}, 
          fat : {y:(event[1]/100)*data[product].fat, x: date}, 
          carbs : {y:(event[1]/100)*data[product].carbs, x: date} 
        })
      }
    }
    events.sort(function(a,b){return a.energy.x.getTime() - b.energy.x.getTime()})//may have to return this into a var?
    return {events:events, dates:dates}
  }

  function get_time_range(dates){
    var date_max = new Date("1900-09-22T00:46:24.679");
    var date_min = new Date("3000-09-22T00:46:24.679");
    for (date of dates){
      if (date > date_max){
        date_max = date
      }
      if (date < date_min){
        date_min = date
      }
    }

    return {max: date_max, min: date_min}
  }

  function pad(period, next_period, events, event, getter, setter){
    date = event.energy.x
    new_events=[]
    if (next_period != period+1){
      event_index = events.indexOf(event)
      difference = next_period - period
      for (let j=1;j<difference;j++){
        date = new Date(date)
        setter(date,getter(date) + 1) 
        new_event = {
          energy : {y:0, x: date},
          protein : {y:0, x: date},
          fat : {y:0, x: date},
          carbs : {y:0, x: date},
        } 
        new_events.push(new_event)
      }
    }
    if(new_events.length){
      padding = {event:event,new_events:new_events}
      return padding
    } else {
      return {}
    }
  }

  function pad_events(events,date_format){
    events_copy = [...events]
    pads = []
    for(i of events_copy){
      padding = {}
      event_index = events.indexOf(i)
      next_i = events[event_index+1] //break if doesnt exist or end of the list
      // date = date.setHours(date.getHours() + 1)// date = date.setDate(date.getDate() + 1)// date = date.setMonth(date.getMonth() + 1)
      if(next_i != undefined){
        if (date_format == 'daily') {
          padding = pad(
              parseInt(i.energy.x/36e5), //hour of event
              parseInt(next_i.energy.x/36e5), //nexthour of event
              events_copy, 
              i, 
              (date) => {return date.getHours()}, 
              (date,hours) => {date.setHours(hours);date.setMinutes(0)}
            )
        } else if (date_format == 'weekly'){
          padding = pad(
              parseInt(i.energy.x.toDateString().split([' '])[2]), //day of event
              parseInt(next_i.energy.x.toDateString().split([' '])[2]), //next day of event
              events_copy, 
              i, 
              (date) => {return date.getDate()}, 
              (date,days) => {date.setDate(days)}
            )
        } else if (date_format == 'monthly'){//this one is difficult (months not padded until implemented)
        } else if (date_format == 'yearly'){
          padding = pad(
            i.energy.x.getMonth(),
            next_i.energy.x.getMonth(),
            events_copy,
            i,
            (date) => {return date.getMonth()},        
            (date,months) => {date.setMonth(months)},
          )
        }
        if (Object.keys(padding).length) pads.push(padding)
      }
    }
    for (i of pads){
      event_index = events_copy.indexOf(i.event)
      events_copy.splice(event_index+1 ,0 , i.new_events)
    }
    events_copy = events_copy.flat()
    return events_copy
  }

  function aggregate_events(events, date_format) {
    let get_period
    if (date_format == 'daily') {
      get_period = event => parseInt(event.energy.x / 36e5)
    } else if (date_format == 'weekly'){
      get_period = event => event.energy.x.toDateString().split([' '])[2]
    } else if (date_format == 'monthly'){
      get_period = event => week_number(event.energy.x)
    } else if (date_format == 'yearly'){
      get_period = event => event.energy.x.getMonth()
    }
    return events.reduce((evs, event, idx) => {
      if (idx === 0 ) return [event] 
      const prev_period = get_period(events[idx - 1])
      const period = get_period(event)
      if(period !== prev_period) {
        return [...evs, event]
      } else {
        const prevEvent = events[idx - 1]
        evs[evs.length-1].energy.y += event.energy.y
        evs[evs.length-1].protein.y += event.protein.y
        evs[evs.length-1].fat.y += event.fat.y
        evs[evs.length-1].carbs.y += event.carbs.y

        return evs
      }
    }, [])
  }

  function week_number(date) {
    year = date.getFullYear()
    month = date.getMonth()
    day = date.getDate()
    UTCdate = Date.UTC(year, month, day)
    date = new Date(UTCdate);
    thursday = date.getUTCDate() + 4
    sunday = (date.getUTCDay()||7)
    date.setUTCDate(thursday - sunday);
    first_day = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    week = Math.ceil(( ( (date - first_day) / 86400000) + 1)/7);
    return week;
  }

  function setup_bars(bars){
    selected = []
    width=1
    count=1
    bar_count = document.querySelectorAll('input[type="checkbox"]:checked').length
    width = width/bar_count-0.05
    bars.map( bar => {
      if (document.getElementById(bar.name).checked){
        width=width
        bar.x = []
        bar.y = []
        bar.hovertemplate = bar.name+": " + bar.hovertemplate
        bar.hoverinfo="x+y"
        bar.offsetgroup = count
        count++
        if (bars_setting.checked) bar.type='bar'
        bar.width = width
        selected.push(bar)
      }
    })
    if (selected.length) selected[0].yaxis='y'
    return selected
  }

  function assign(bars,events){
    events.map(event => {
      bars.map( bar => {
        bar.x.push(event[bar.name].x)
        bar.y.push(event[bar.name].y)
      }) 
    })
  }

  function max_in_array(array){ 
    var max = array.reduce(function(a, b) {
        return Math.max(a, b);
      }, 0);
      return max
  }

  function format_time(events,range){
    for(let i=0;i<events.length;i++){
      for(macro in events[i]){
        macro = events[i][macro]
        dmy = macro.x.toLocaleDateString('en-GB')
        hour = macro.x.toLocaleString('en-GB').split(' ')[1].slice(0,2)
        if (parseInt(hour) >= 12){
          hour=(parseInt(hour)-12)+'pm'
          if (hour[0]=='0') hour = '12'+hour.slice(1) 
        } else {
          hour=hour+'am'
          if(hour[0]=='0') 
            hour = hour.slice(1)
            if (hour[0]=='0') hour = '12'+hour.slice(1) 
        }   
        hour = hour + ' ' +(dmy.slice(0,5))
        dmy = dmy.slice(0,6) + dmy.slice(8,10)
        if(range == 'daily'){
          macro.x = hour
        } else if (range == 'yearly') {
          dmy = dmy.slice(-5)
          macro.x = dmy
        } else {
          macro.x = dmy
        }
      }
    }
    return events
  }

  function check_ticklen(y_max,last_ticklen){
    y_max=parseInt(y_max)
    y_len = String(y_max).length
    char_length = 8.75
    
    if (y_len >= 5) {
      y_len = y_len-2
      ticklen = (char_length*y_len) 
    } else {
      ticklen = (char_length*y_len) + last_ticklen
    }
    if (y_len == 1) ticklen += 7
    return ticklen
  }

  function create_graph(){ 
    var hovertemplate = '%{y:,.0f}<br>'+'date: %{x}' + "<extra></extra>"
    var inactivity_button = document.getElementById('inactivity')
    var energy = {name : 'energy' , marker : {color:'blue'}, yaxis:'y', hovertemplate: hovertemplate}
    var protein = {name : 'protein' , marker : {color:'red'}, yaxis:'y2', hovertemplate: hovertemplate}
    var fat = {name : 'fat' , marker : {color:'orange'}, yaxis:'y3', hovertemplate: hovertemplate}
    var carbs = {name : 'carbs' , marker : {color:'green'}, yaxis:'y4', hovertemplate: hovertemplate}
    var selected = []
    var dates = []

    for (i of buttons){
      if (i.checked){
      var date_format=i.value
      }
    }
    if(date_format != 'yearly'){
      document.getElementById('pagination').style='visibility:visible;'
      document.getElementById('slider').style='visibility:visible;'
    } else {
      document.getElementById('pagination').style='visibility:hidden;'
      document.getElementById('slider').style='visibility:hidden;'
      document.getElementById('pag-text').innerText = ''
    }
    events_dates = collect(a)
    dates = events_dates.dates
    if (inactivity_button.innerText == 'Hide Inactivity'){
      padded_events = pad_events(events_dates.events, date_format)
      aggregated_events = aggregate_events(padded_events, date_format)
    } else {
      aggregated_events = aggregate_events(events_dates.events, date_format)
    }
    events = format_time(aggregated_events,date_format)

    if (bars_setting.checked || lines_setting.checked){
      bars = setup_bars([energy,protein,fat,carbs]) //these are copied and added as lines later
      if (bars.length){
        var first_yaxis_color = bars[0].marker.color
      }
    }
    pages = paginate(events, date_format)
  
    if (pages.length){
      text = document.getElementById('pag-text').innerText
      text = text.split('/')
      page_number = text[0]
      events = pages[page_number-1]
      
    }
    x_line_pos = 0.03
    if (typeof InstallTrigger !== 'undefined'){//checks if browser is firefox
        x_line_pos = 0.06
    }
    assign(bars, events)
    dates = get_time_range(dates.flat())
    x_labels=[]
    if (bars.length){
      for(i of bars[0].x){
        x_labels.push(i)
      }
    }
    last_ticklen = 0
    lines = []
    ticklens = {
      y:0,
      y2:0,
      y3:0,
      y4:0
    }
    total_ticklen = 0
    if (bars.length){
      bars.map(bar => {
        max_y = max_in_array(bar.y)
        if(bars.indexOf(bar) == 0){
          last_ticklen = check_ticklen(max_y,last_ticklen)
        } else {
          ticklens[bar.yaxis]=last_ticklen
          last_ticklen = check_ticklen(max_y,last_ticklen)
        }
        total_ticklen += last_ticklen
      if (lines_setting.checked){
        new_line = {...bar}
        // if (new_line.name == 'energy') new_line.marker = {color:'rgb()'}
        new_line.type = 'scatter'
        lines.push(new_line)
        }
      })
      selected = [bars, lines].flat()
    } 
    left_margin = 90
    if (total_ticklen <= 35) {
      left_margin = 64
    } else if (total_ticklen>245){
      left_margin = left_margin + (total_ticklen/10) 
    } else {
      left_margin = left_margin + (total_ticklen/21) 
    }
    layout = {
      margin: {
        l: Math.ceil(left_margin),
        r: 45,
        b: 32,
        t: 0,
        pad: 0
      },
      annotations:[{showarrow:false,text:''}],
      showlegend: false,
      yaxis: {  
        domain: [x_line_pos,1],
        showspikes: true,
        fixedrange:true,
        rangemode: 'tozero',
        ticklen:ticklens['y'],
        tickfont:{color:first_yaxis_color}
      },
      yaxis2: {  
        showspikes: true,
        fixedrange:true,
        rangemode: 'tozero',
        overlaying:'y',
        ticklen: ticklens['y2'],
        tickfont:{color:'red'}
      },
      // hovermode:"closest",
      yaxis3: {  
        showspikes: true,
        fixedrange:true,
        rangemode: 'tozero',
        overlaying:'y',
        ticklen:ticklens['y3'],
        tickfont:{color:'orange'}
      },
      yaxis4: {  
        showspikes: true,
        fixedrange:true,
        rangemode: 'tozero',
        showdividers:false,
        ticklen:ticklens['y4'],
        overlaying:'y',
        tickfont:{color:'green'}
      },
      xaxis: {
        showspikes: true,
        fixedrange:true,
        range: [dates.min, dates.max], 
        // range: x_labels, 
        tickmode:'linear',
        zeroline: true,
      },
      barmode:'group',
    }
    if (x_labels.length > 7) {
      layout.margin.b = 69
      layout.xaxis.tickangle = 55
      layout.xaxis.tickfont = {size:14,}
    }
    if (x_labels.length > 30) {
      document.getElementById('chart').style='overflow:scroll;overflow-y: hidden;'
      layout.width = 22*x_labels.length
    } else {
      document.getElementById('chart').style=''
    }


    Plotly.newPlot(chart, selected, layout)
    ticks = document.getElementsByClassName('ticks')
    for (tick of ticks){
      tick.style=''
    }
  }
  
  create_graph()


</script>
</html>
